<!--
                  _         _                      _ _                 _
 _   _  __ ___  _(_)_ __   | | _____   _____    __| (_)_ __   __ _  __| | __ _ _ __   __ _
| | | |/ _` \ \/ / | '_ \  | |/ _ \ \ / / _ \  / _` | | '_ \ / _` |/ _` |/ _` | '_ \ / _` |
| |_| | (_| |>  <| | | | | | | (_) \ V /  __/ | (_| | | | | | (_| | (_| | (_| | | | | (_| |
 \__, |\__,_/_/\_\_|_| |_| |_|\___/ \_/ \___|  \__,_|_|_| |_|\__, |\__,_|\__,_|_| |_|\__, |
 |___/                                                       |___/                   |___/
-->
<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="utf-8">
  
  <title>Docker中使用固定IP | 馨木</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <link rel="alternative" href="/rss.xml" title="馨木" type="application/rss+xml">
  
  
  <link rel="icon" href="/assets/favicon.ico">
  <link rel="stylesheet" href="/assets/app.css">
<link rel="stylesheet" href="/assets/highlight-default.css">
<link rel="stylesheet" href="/assets/pace-theme-flash.css">

  <!-- <script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script> -->
  <!--[if lt IE 9]>
    <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <![endif]-->
</head>


<body id="sinle-post">
  <header id="site-header">
  <div id="site-nav">
    <nav class="site-nav">
      <ul>
        <li ><a href="/">所有文章</a></li>
        <li ><a href="/about.html">关于我</a></li>
      </ul>
    </nav>
  </div>
  <div id="site-title">
	
  </div>
</header> <!-- #site-header -->
  <div id="site-main">
    <article id="post-1418278448" class="article article-type-post">
  <header class="post-header">
    <div class="post-header-wrap">
      <h1 class="post-title" itemprop="name"><a href="http://yaxin-cn.github.io/Docker/docker-container-use-static-IP.html" rel="bookmark" title="Docker中使用固定IP" itemprop="url">Docker中使用固定IP</a></h1>
      <h2>2014-12-11</h2>
    </div><!-- .post-header-wrap -->
  </header>
  <div class="section-box">
    <div class="post-content">
      <p>默认情况下启动一个container，其会自动获取一个跟<code>docker0</code>同网段的IP，而且重启container其IP一般会发生变化，但有时候我们会需要固定的IP。要实现这个并不困难。</p>
<p><a href="https://docs.docker.com/reference/commandline/cli/#run" target="_blank" rel="external"><code>docker run</code></a>启动一个container的命令有一个<code>--net</code>的参数用于指定container的网络类型</p>
<blockquote>
<p>--net=”bridge”  Set the Network mode for the container<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;’bridge’: creates a new network stack for the container on the docker bridge<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;’none’: no networking for this container<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;’container:&lt;name|id&gt;’: reuses another container network stack<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;’host’: use the host network stack inside the container.  Note: the host mode gives the container full access to local system services such as D-bus and is therefore considered insecure. </p>
</blockquote>
<p>docker默认使用’bridge’来设置container的网络模式（即从与docker0同网段的未使用的IP中取一个作为container的IP），我们这里使用’<strong>none</strong>‘来实现自己手动配置container的网络。</p>
<p>首先我们以<strong><code>--net=&#39;none&#39;</code></strong>的方式启动一个container</p>
<pre><code class="shell">[yaxin@cube2x ~]$docker run -i -t --rm --net=&#39;none&#39; ubuntu /bin/bash
root@db84e747c362:/# ifconfig -a
lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

root@db84e747c362:/#
</code></pre>
<p>可以看到，由于我们使用’none’模式，container中没有获取到IP，甚至连网卡都没有，下面我们开始给container配置IP</p>
<p>首先获取container的pid（我们需要通过pid获取file descriptor）</p>

```bash
[yaxin@cube2x ~]$docker ps
CONTAINER ID        IMAGE                            COMMAND             CREATED             STATUS              PORTS               NAMES
db84e747c362        docker.cn/docker/ubuntu:latest   "/bin/bash"         4 minutes ago       Up 4 minutes                            sharp_kirch
[yaxin@cube2x ~]$docker inspect -f "{{.State.Pid}}" sharp_kirch
23090
```

<p>ip-netns的man page中有这样一句</p>
<blockquote>
<p>By convention a named network namespace is an object at /var/run/netns/NAME that can be opened.  The file descriptor resulting from opening/var/run/netns/NAME refers to the specified network namespace</p>
</blockquote>
<p>因而我们需要创建一个链接</p>
<pre><code class="shell">[yaxin@cube2x ~]$sudo ln -s /proc/23090/ns/net /var/run/netns/23090
</code></pre>
<p>然后创建一对端到端的网卡，将<code>veth_db84e747c3</code>绑定到docker0网桥，并启动。将另一块网卡<code>X</code>放到container内部</p>
<pre><code class="shell">[yaxin@cube2x ~]$sudo ip link add veth_db84e747c3 type veth peer name X
[yaxin@cube2x ~]$sudo brctl addif docker0 veth_db84e747c3
[yaxin@cube2x ~]$sudo ip link set veth_db84e747c3 up
[yaxin@cube2x ~]$sudo ip link set X netns 23090
</code></pre>
<p>这时查看container的IP，会发现多了一个名为<code>X</code>的网卡</p>
<pre><code class="shell">root@db84e747c362:/# ifconfig  -a
X         Link encap:Ethernet  HWaddr 5a:7e:4d:ba:63:1c  
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

root@db84e747c362:/#
</code></pre>
<p>然后对container内部新添加的网卡进行配置（可以通过<code>man ip-netns</code>更详细查看）</p>
<pre><code>[yaxin@cube2x ~]$sudo ip netns exec 23090 ip link set dev X name eth0
[yaxin@cube2x ~]$sudo ip netns exec 23090 ip link set eth0 up
[yaxin@cube2x ~]$sudo ip netns exec 23090 ip addr add 172.17.111.10/16 dev eth0
[yaxin@cube2x ~]$sudo ip netns exec 23090 ip route add default via 172.17.42.1
</code></pre><p><strong>注意: 指定给container的IP必须跟docker0在同一网段,且给container的网关应该为docker0的IP</strong></p>
<p>最后，写成shell脚本如下:</p>

```shell
#!/usr/bin/env bash
# filename: bind_addr.sh

if [ `id -u` -ne 0 ];then
    echo '必须使用root权限'
    exit
fi

if [ $# != 2 ]; then
    echo "使用方法: $0 容器名字 IP"
    exit 1
fi

container_name=$1
bind_ip=$2

container_id=`docker inspect -f '{{.Id}}' $container_name 2> /dev/null`
if [ ! $container_id ];then
    echo "容器不存在"
    exit 2
fi
bind_ip=`echo $bind_ip | egrep '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$'`
if [ ! $bind_ip ];then
    echo "IP地址格式不正确"
    exit 3
fi

container_minid=`echo $container_id | cut -c 1-10`
container_netmask=`ip addr show docker0 | grep "inet\b" | awk '{print $2}' | cut -d / -f2`
container_gw=`ip addr show docker0 | grep "inet\b" | awk '{print $2}' | cut -d / -f1`

bridge_name="veth_$container_minid"
container_ip=$bind_ip/$container_netmask
pid=`docker inspect -f '{{.State.Pid}}' salt-master 2> /dev/null`
if [ ! $pid ];then
    echo "获取容器$container_name的id失败"
    exit 4
fi

if [ ! -d /var/run/netns ];then
    mkdir -p /var/run/netns
fi

ln -sf /proc/$pid/ns/net /var/run/netns/$pid

ip link add $bridge_name type veth peer name X
brctl addif docker0 $bridge_name
ip link set $bridge_name up
ip link set X netns $pid
ip netns exec $pid ip link set dev X name eth0
ip netns exec $pid ip link set eth0 up
ip netns exec $pid ip addr add $container_ip dev eth0
ip netns exec $pid ip route add default via $container_gw
```


    </div> <!-- .post-content -->
    <div class="post-footer">
      <div class="entry-meta article-entry-meta clearfix">
        <div class="entry-date date published updated pull-left mr-10">
          <i class="icon-clock"></i><time datetime="2014-12-11T06:14:08.000Z" itemprop="datePublished">2014-12-11</time>
        </div>
        <div class="entry-tags pull-left clearfix">
          
            <i class="icon-tags"></i>
            <a class="article-tag-link" href="/tags/Docker/">Docker</a>
          
        </div>
      </div><!-- .entry-meta -->
    </div> <!-- .post-footer -->
  </div>
</article>



  </div> <!-- #site-main -->
  <footer id="site-footer">
  <div class="copyright">
    <span>&copy; 2014 yaxin</span>
  </div>
  <div class="site-script">
    <script>
      window.headerBg = '//yaxin-cn.qiniudn.com/@/blog/IMG_1568-low.jpg,//yaxin-cn.qiniudn.com/@/blog/IMG_0262.jpg';
    </script>
    <script src="/assets/app.js"></script>
<script src="/assets/pace.min.js"></script>
<script src="/assets/highlight.pack.js"></script>

    <script>
      // var site_header = document.getElementById('site-header');
      // var img_urls = site_header.getAttribute('data-bg-images');
      // var header_bg_array = img_urls.split(',');
      // var header_bg_len = header_bg_array.length;
      // var random_num = parseInt(Math.random() * header_bg_len);
      // site_header.style.backgroundImage = 'url("' + header_bg_array[random_num] + '")';
      hljs.initHighlightingOnLoad();
    </script>
  </div>
  <div id="tongji" style="display: none">
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_5926023'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/stat.php%3Fid%3D5926023' type='text/javascript'%3E%3C/script%3E"));</script>
  </div>
</footer> <!-- #site-footer -->

</body>
</html>
